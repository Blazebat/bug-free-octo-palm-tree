<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Skywatch Live EPG</title>
  <link rel="icon" href="logo.png" />
  <style>
    /* General layout */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #121212;
      color: white;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Header fixed */
    header {
      height: 60px;
      background: #1e1e1e;
      display: flex;
      align-items: center;
      padding: 0 15px;
      gap: 10px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }

    header .logo {
      height: 40px;
    }

    header h1 {
      font-size: 18px;
      margin: 0;
    }

    .back-btn {
      background: #333;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      color: white;
      cursor: pointer;
      font-size: 14px;
      margin-left: auto;
    }

    /* Footer fixed */
    footer {
      height: 40px;
      background: #1e1e1e;
      display: flex;
      align-items: center;
      justify-content: center;
      border-top: 1px solid #333;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }

    .footer-content {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #bbb;
      font-size: 14px;
    }

    .footer-logo {
      height: 24px;
      object-fit: contain;
    }

    /* Main EPG container */
    #epgArea {
      margin-top: 60px;
      margin-bottom: 40px;
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .channel-row {
      background: #1e1e1e;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .channel-logo {
      width: 60px;
      height: 40px;
      object-fit: contain;
      background: #272727;
      border-radius: 4px;
    }

    .show-info {
      flex: 1;
    }

    .channel-name {
      font-size: 14px;
      font-weight: bold;
      margin: 0 0 4px;
    }

    .show-title {
      font-size: 13px;
      color: #ddd;
      margin: 0;
    }

    .show-time {
      font-size: 12px;
      color: #bbb;
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Skywatch" class="logo">
    <h1>Skywatch Live EPG</h1>
    <button class="back-btn" onclick="window.location.href='https://skywatch-sigma.vercel.app'">← Back</button>
  </header>

  <main id="epgArea">
    <p>Loading live EPG data...</p>
  </main>

  <footer>
    <div class="footer-content">
      <img src="logo.png" alt="Skywatch" class="footer-logo">
      <span>Skywatch © 2025</span>
    </div>
  </footer>

  <script>
    const epgUrls = [
      "https://cignal1.vercel.app/api/proxy-epg?url=https%3A%2F%2Fepgshare01.online%2Fepgshare01%2Fepg_ripper_PH1.xml.gz",
      "https://cignal1.vercel.app/api/proxy-epg?url=https%3A%2F%2Fepgshare01.online%2Fepgshare01%2Fepg_ripper_PH2.xml.gz"
    ];

    async function loadEPG() {
      const epgArea = document.getElementById("epgArea");
      for (const url of epgUrls) {
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error("Failed to fetch EPG");
          const xmlText = await res.text();
          const parser = new DOMParser();
          const xml = parser.parseFromString(xmlText, "application/xml");

          const channels = xml.querySelectorAll("channel");
          const programmes = xml.querySelectorAll("programme");

          epgArea.innerHTML = "";

          const now = new Date();

          channels.forEach(channel => {
            const id = channel.getAttribute("id");
            const name = channel.querySelector("display-name")?.textContent || id;
            const icon = channel.querySelector("icon")?.getAttribute("src") || "logo.png";

            // find current programme
            const current = Array.from(programmes).find(p => {
              if (p.getAttribute("channel") !== id) return false;
              const start = parseEPGDate(p.getAttribute("start"));
              const end = parseEPGDate(p.getAttribute("stop"));
              return now >= start && now <= end;
            });

            if (current) {
              const title = current.querySelector("title")?.textContent || "No title";
              const start = current.getAttribute("start");
              const end = current.getAttribute("stop");

              const showTime = formatTimeRange(start, end);

              epgArea.innerHTML += `
                <div class="channel-row">
                  <img src="${icon}" class="channel-logo" onerror="this.src='logo.png'">
                  <div class="show-info">
                    <p class="channel-name">${name}</p>
                    <p class="show-title">${title}</p>
                    <p class="show-time">${showTime}</p>
                  </div>
                </div>
              `;
            }
          });

          if (!epgArea.innerHTML.trim()) {
            epgArea.innerHTML = "<p>No live shows found at this moment.</p>";
          }
          return; // success
        } catch (e) {
          console.error("EPG load error from", url, e);
        }
      }
      epgArea.innerHTML = "<p>Failed to load EPG data.</p>";
    }

    function parseEPGDate(str) {
      const match = str.match(/(\d{14})\s?([+\-]\d{4})?/);
      if (!match) return new Date();
      const [ , datetime, offset ] = match;
      const year = datetime.slice(0,4);
      const month = datetime.slice(4,6);
      const day = datetime.slice(6,8);
      const hour = datetime.slice(8,10);
      const min = datetime.slice(10,12);
      const sec = datetime.slice(12,14);
      return new Date(`${year}-${month}-${day}T${hour}:${min}:${sec}${offset || "+0800"}`);
    }

    function formatTimeRange(start, end) {
      const options = { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Manila' };
      const s = parseEPGDate(start).toLocaleTimeString('en-PH', options);
      const e = parseEPGDate(end).toLocaleTimeString('en-PH', options);
      return `${s} - ${e} (Manila)`;
    }

    // Initial load
    loadEPG();
    // Refresh every hour (3600000 ms)
    setInterval(loadEPG, 3600000);
  </script>
</body>
</html>
