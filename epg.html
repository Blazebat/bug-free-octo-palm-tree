<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Skywatch EPG</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Header -->
  <header>
    <img src="logo.png" alt="Skywatch" class="logo">
    <h1>Skywatch EPG</h1>
    <button onclick="window.location.href='https://skywatch-sigma.vercel.app'" id="backButton">← Back</button>
  </header>

  <!-- Main EPG List -->
  <main id="epgList" style="margin-top:60px; margin-bottom:40px; overflow-y:auto; flex:1; padding:10px;"></main>

  <!-- Footer -->
  <footer>
    <div class="footer-content">
      <span>© 2025 Skywatch</span>
    </div>
  </footer>

  <script type="module">
    import handler from "./channels.js";

    // extract "channels" array from handler()
    const channelsData = (() => {
      let res = {};
      handler({}, { json: obj => res = obj });
      return res.channels || [];
    })();

    const epgUrls = [
      "https://cignal1.vercel.app/api/proxy-epg?url=https%3A%2F%2Fepgshare01.online%2Fepgshare01%2Fepg_ripper_PH1.xml.gz",
      "https://cignal1.vercel.app/api/proxy-epg?url=https%3A%2F%2Fepgshare01.online%2Fepgshare01%2Fepg_ripper_PH2.xml.gz"
    ];

    const epgList = document.getElementById("epgList");

    async function loadEPG() {
      try {
        let xmlText = "";
        for (let url of epgUrls) {
          const res = await fetch(url);
          if (res.ok) {
            xmlText = await res.text();
            if (xmlText) break;
          }
        }
        if (!xmlText) throw new Error("No EPG data");

        const parser = new DOMParser();
        const xml = parser.parseFromString(xmlText, "text/xml");

        const channels = [...xml.querySelectorAll("channel")];
        const progs = [...xml.querySelectorAll("programme")];

        const now = new Date();
        const manilaTime = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Manila" }));

        epgList.innerHTML = "";

        channels.forEach(ch => {
          const id = ch.getAttribute("id");
          const name = ch.querySelector("display-name")?.textContent || "Unnamed";

          // Look up logo from channels.js
          const match = channelsData.find(c => c.name.toLowerCase() === name.toLowerCase());
          const logo = match?.logo || "default-logo.png";

          // Find current program
          const current = progs.find(p => {
            if (p.getAttribute("channel") !== id) return false;
            const start = parseDate(p.getAttribute("start"));
            const stop = parseDate(p.getAttribute("stop"));
            return manilaTime >= start && manilaTime < stop;
          });

          const title = current ? current.querySelector("title")?.textContent : "No show right now";

          const card = document.createElement("div");
          card.className = "channel-card";
          card.innerHTML = `
            <img src="${logo}" alt="${name}">
            <span><b>${name}</b></span>
            <span>${title}</span>
          `;
          epgList.appendChild(card);
        });

      } catch (err) {
        epgList.innerHTML = `<p style="color:red;">Error loading EPG: ${err.message}</p>`;
      }
    }

    function parseDate(str) {
      if (!str) return new Date(0);
      const match = str.match(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/);
      if (!match) return new Date(0);
      const [_, y, m, d, hh, mm, ss] = match;
      return new Date(`${y}-${m}-${d}T${hh}:${mm}:${ss}+08:00`); // Manila TZ
    }

    loadEPG();
    setInterval(loadEPG, 3600000); // refresh every hour
  </script>
</body>
</html>
